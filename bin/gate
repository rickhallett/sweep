#!/usr/bin/env bash
# The Gate - must pass before any task is "done"
# Returns non-zero on failure with verbose output

set -e

echo "ğŸš¦ Running gate..."
echo ""

# Detect package manager
if [ -f "pnpm-lock.yaml" ]; then
    PKG="pnpm"
elif [ -f "yarn.lock" ]; then
    PKG="yarn"
elif [ -f "bun.lockb" ]; then
    PKG="bun"
else
    PKG="npm"
fi

FAILED=0

# Type check (TypeScript)
if [ -f "tsconfig.json" ]; then
    echo "ğŸ“˜ Type checking..."
    if $PKG run typecheck 2>/dev/null || npx tsc --noEmit; then
        echo "   âœ… Types OK"
    else
        echo "   âŒ Type errors"
        FAILED=1
    fi
    echo ""
fi

# Format check (Prettier/Biome)
if $PKG run format:check &>/dev/null; then
    echo "ğŸ¨ Format checking..."
    if $PKG run format:check; then
        echo "   âœ… Format OK"
    else
        echo "   âŒ Format issues (run: $PKG run format)"
        FAILED=1
    fi
    echo ""
fi

# Lint
echo "ğŸ” Linting..."
if $PKG run lint 2>/dev/null; then
    echo "   âœ… Lint OK"
else
    echo "   âŒ Lint errors"
    FAILED=1
fi
echo ""

# Test
echo "ğŸ§ª Testing..."
if $PKG run test 2>/dev/null; then
    echo "   âœ… Tests OK"
else
    echo "   âŒ Test failures"
    FAILED=1
fi
echo ""

# Build check (optional â€” catches more issues)
if $PKG run build &>/dev/null; then
    echo "ğŸ—ï¸  Build check..."
    if $PKG run build; then
        echo "   âœ… Build OK"
    else
        echo "   âŒ Build failed"
        FAILED=1
    fi
    echo ""
fi

# Summary
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $FAILED -eq 0 ]; then
    echo "âœ… Gate passed. Ready to ship."
    exit 0
else
    echo "âŒ Gate failed. Fix issues above."
    exit 1
fi
