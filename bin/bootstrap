#!/usr/bin/env bash
# Agent self-healing bootstrap script
# Idempotent â€” safe to run repeatedly

set -e

echo "ğŸ”§ Running bootstrap..."

# Check Node
if ! command -v node &>/dev/null; then
    echo "âŒ Node not found."
    if command -v mise &>/dev/null; then
        echo "   â†’ Installing via mise..."
        mise install node@lts
        mise use node@lts
    else
        echo "   â†’ Install Node via mise, nvm, or your package manager"
        exit 1
    fi
fi
echo "âœ… Node $(node -v)"

# Check package manager
if [ -f "pnpm-lock.yaml" ]; then
    PKG="pnpm"
    if ! command -v pnpm &>/dev/null; then
        echo "ğŸ“¦ Installing pnpm..."
        npm i -g pnpm
    fi
elif [ -f "yarn.lock" ]; then
    PKG="yarn"
elif [ -f "bun.lockb" ]; then
    PKG="bun"
else
    PKG="npm"
fi
echo "ğŸ“¦ Using $PKG"

# Install dependencies
echo "ğŸ“¥ Installing dependencies..."
$PKG install

# Check env
if [ ! -f ".env.local" ]; then
    if [ -f ".env.example" ]; then
        echo "âš ï¸  No .env.local found. Creating from .env.example..."
        cp .env.example .env.local
        echo "   â†’ Fill in the values in .env.local"
    fi
fi

# Check for required env vars (customize this list)
if [ -f ".env.local" ]; then
    source .env.local
    # Example checks:
    # [[ -z "$API_KEY" ]] && echo "âš ï¸  API_KEY not set in .env.local"
    # [[ -z "$DATABASE_URL" ]] && echo "âš ï¸  DATABASE_URL not set in .env.local"
fi

# Run database migrations if applicable
if [ -f "prisma/schema.prisma" ]; then
    echo "ğŸ—„ï¸  Running Prisma migrations..."
    npx prisma migrate dev --name init 2>/dev/null || npx prisma db push
fi

if [ -f "drizzle.config.ts" ]; then
    echo "ğŸ—„ï¸  Running Drizzle migrations..."
    npx drizzle-kit push 2>/dev/null || true
fi

# Run gate to verify environment
echo ""
echo "ğŸš¦ Verifying environment..."
./bin/gate 2>/dev/null && echo "âœ… Gate passed" || echo "âš ï¸  Gate has issues (run ./bin/gate for details)"

echo ""
echo "âœ… Bootstrap complete."
